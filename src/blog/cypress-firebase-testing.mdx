---
slug: "/blog/cypress-firebase-auth-testing"
date: "2020-06-19"
title: "Testing Firebase Authentication with Cypress"
langKey: "en"
---

import { ExternalLink } from '../components/mdx/externalLink.jsx'

I recently wrote some Cypress tests for a project that uses Firebase. While most of the stuff was pretty much straight forward, I had some trouble testing the the authentication flow. Signing up is no problem, but after or before the test case test user should be deleted. The problem here is, that Firebase Admin SDK that is needed to do this, need a node.js environment. 

At first I stumbled upon the Cypress-Firebase lib. The project is really well documented and uptodate. But I felt like it won't help me with the initial problem - deleting the user after the test run. That's why I searched for another way. And I found one: Cypress allows calling a node script right from the test case itself. And that's what we are going to do.

The <ExternalLink href='https://docs.cypress.io/api/commands/exec.html'>cy.exec</ExternalLink> function allows us to run a system command. So, why not calling a node script that initilizes the firebase admin sdk and deletes our user?

```
// clearFirebase.js
var admin = require('firebase-admin')
var app = admin.initializeApp()

admin
    .auth()
    .getUserByEmail(<theEmail>)
    .then(function (userRecord) {
        admin
            .auth()
            .deleteUser(userRecord.uid)
            .then(function () {
                console.log('Successfully deleted user')
                process.exit(0)
            })
            .catch(function (error) {
                console.log(error.code)
                process.exit(1)
            })
    })
    .catch(function (error) {
        console.log('Error fetching user data:', error)
        process.exit(1)
    })
```

To use the admin SDK you need to initlize it with credentials. If initlized in the above shown way, the credential file needs to be linked to a local environment variable like so: `export GOOGLE_APPLICATION_CREDENTIALS="/home/user/service-account-file.json"`. You can read more about <ExternalLink href='https://firebase.google.com/docs/admin/setup#initialize-sdk'>initilizing here</ExternalLink>.

This is pretty basic. You can read more about it at the offical <ExternalLink href='https://firebase.google.com/docs/auth/admin/manage-users#delete_a_user'>firebase docs</ExternalLink>. But there is one missing piece: `.getUserByEmail(<theEmail>)`. Our cypress test needs to somehow provide a user identifier to the script. To make this possible we pass a environment variable to the script:

```
//yourtest.spec.js
cy.exec('node ./cypress/cleanupFirebase.js', {
    // user.email comes from a fixture file but you can use a simple string as well
    env: { email: user.email }
}).then((result) => {
    //Just for debugging
    console.log(result.code)
    console.log(result.stderr)
    console.log(result.stdout)
})
```

While this will allready work, there is still a small issue. The test state, in this case the existence of the test user, should be clean before and after the test run. Because your test case allways mount on a clean and stabel state. The <ExternalLink href='https://docs.cypress.io/guides/references/best-practices.html#Using-after-or-afterEach-hooks'>cypress docs</ExternalLink> says  the state should be cleaned _before_ testing. If the test user doesn't exit, the firebase.auth will throw an error. Since we want to continue our test case we need to handle this error:

```
// clearFirebase.js
.catch(function (error) {
        if (error.code === 'auth/user-not-found') process.exit(0)
        console.log('Error fetching user data:', error)
        process.exit(1)
    })
```
Now we catch the _auth/user-not-found_ error code an resume our test case if the user allready exists.

